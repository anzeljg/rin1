// Copyright 2011 David Galles, University of San Francisco. All rights reserved.
//
// Redistribution and use in source and binary forms, with or without modification, are
// permitted provided that the following conditions are met:
//
// 1. Redistributions of source code must retain the above copyright notice, this list of
// conditions and the following disclaimer.
//
// 2. Redistributions in binary form must reproduce the above copyright notice, this list
// of conditions and the following disclaimer in the documentation and/or other materials
// provided with the distribution.
//
// THIS SOFTWARE IS PROVIDED BY <COPYRIGHT HOLDER> ``AS IS'' AND ANY EXPRESS OR IMPLIED
// WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
// FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL <COPYRIGHT HOLDER> OR
// CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
// CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
// SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
// ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
// ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
//
// The views and conclusions contained in the software and documentation are those of the
// authors and should not be interpreted as representing official policies, either expressed
// or implied, of the University of San Francisco


// Object Manager
//
// Manage all of our animated objects.  Control any animated object should occur through
// this interface (not language enforced, because enforcing such things in Javascript is 
// problematic.)
//
// This class is only accessed through:
//
//  AnimationMain
//  Undo objects (which are themselves controlled by AnimationMain


// TODO: 
//       1.  Add proper throws for all error conditions (perhaps guarded by
//           an assert-like structure that can be turned off for production?)
//       2.  Refactor this code so that it uses the same object syntax (with 
//           prototypes) as te rest of the code.  (low priority)

function ObjectManager(){this.Nodes=[],this.Edges=[],this.BackEdges=[],this.activeLayers=[],this.activeLayers[0]=!0,this.ctx=document.getElementById("canvas").getContext("2d"),this.framenum=0,this.width=0,this.height=0,this.statusReport=new AnimatedLabel(-1,"XXX",!1,30),this.statusReport.x=30,this.draw=function(){this.framenum++,this.framenum>1e3&&(this.framenum=0),this.ctx.clearRect(0,0,this.width,this.height),this.statusReport.y=this.height-15;var t,s;for(t=0;t<this.Nodes.length;t++)null==this.Nodes[t]||this.Nodes[t].highlighted||!this.Nodes[t].addedToScene||this.Nodes[t].alwaysOnTop||this.Nodes[t].draw(this.ctx);for(t=0;t<this.Nodes.length;t++)null!=this.Nodes[t]&&this.Nodes[t].highlighted&&!this.Nodes[t].alwaysOnTop&&this.Nodes[t].addedToScene&&(this.Nodes[t].pulseHighlight(this.framenum),this.Nodes[t].draw(this.ctx));for(t=0;t<this.Nodes.length;t++)null!=this.Nodes[t]&&this.Nodes[t].alwaysOnTop&&this.Nodes[t].addedToScene&&(this.Nodes[t].pulseHighlight(this.framenum),this.Nodes[t].draw(this.ctx));for(t=0;t<this.Edges.length;t++)if(null!=this.Edges[t])for(s=0;s<this.Edges[t].length;s++)this.Edges[t][s].addedToScene&&(this.Edges[t][s].pulseHighlight(this.framenum),this.Edges[t][s].draw(this.ctx));this.statusReport.draw(this.ctx)},this.update=function(){},this.setLayers=function(t,s){for(var e=0;e<s.length;e++)this.activeLayers[s[e]]=t;this.resetLayers()},this.addHighlightCircleObject=function(t,s,e){if(null!=this.Nodes[t]&&void 0!=this.Nodes[t])throw"addHighlightCircleObject:Object with same ID ("+String(t)+") already Exists!";var i=new HighlightCircle(t,s,e);this.Nodes[t]=i},this.setEdgeAlpha=function(t,s,e){var i=1;if(null!=this.Edges[t]&&void 0!=this.Edges[t])for(var d=this.Edges[t].length,h=d-1;h>=0;h--)null!=this.Edges[t][h]&&void 0!=this.Edges[t][h]&&this.Edges[t][h].Node2==this.Nodes[s]&&(i=this.Edges[t][h].alpha,this.Edges[t][h].alpha=e);return i},this.setAlpha=function(t,s){null!=this.Nodes[t]&&void 0!=this.Nodes[t]&&this.Nodes[t].setAlpha(s)},this.getAlpha=function(t){return null!=this.Nodes[t]&&void 0!=this.Nodes[t]?this.Nodes[t].getAlpha():-1},this.getTextColor=function(t,s){return null!=this.Nodes[t]&&void 0!=this.Nodes[t]?this.Nodes[t].getTextColor(s):"#000000"},this.setTextColor=function(t,s,e){null!=this.Nodes[t]&&void 0!=this.Nodes[t]&&this.Nodes[t].setTextColor(s,e)},this.setAllLayers=function(t){this.activeLayers=[];for(var s=0;s<t.length;s++)this.activeLayers[t[s]]=!0;this.resetLayers()},this.resetLayers=function(){var t;for(t=0;t<this.Nodes.length;t++)null!=this.Nodes[t]&&void 0!=this.Nodes[t]&&(this.Nodes[t].addedToScene=1==this.activeLayers[this.Nodes[t].layer]);for(t=this.Edges.length-1;t>=0;t--)if(null!=this.Edges[t]&&void 0!=this.Edges[t])for(var s=0;s<this.Edges[t].length;s++)null!=this.Edges[t][s]&&void 0!=this.Edges[t][s]&&(this.Edges[t][s].addedToScene=1==this.activeLayers[this.Edges[t][s].Node1.layer]&&1==this.activeLayers[this.Edges[t][s].Node2.layer])},this.setLayer=function(t,s){if(null!=this.Nodes[t]&&void 0!=this.Nodes[t]){if(this.Nodes[t].layer=s,this.activeLayers[s]?this.Nodes[t].addedToScene=!0:this.Nodes[t].addedToScene=!1,null!=this.Edges[t]&&void 0!=this.Edges[t])for(var e=0;e<this.Edges[t].length;e++){var i=this.Edges[t][e];null!=i&&void 0!=i&&(i.addedToScene=i.Node1.addedToScene&&i.Node2.addedToScene)}if(null!=this.BackEdges[t]&&void 0!=this.BackEdges[t])for(var e=0;e<this.BackEdges[t].length;e++){var i=this.BackEdges[t][e];null!=i&&void 0!=i&&(i.addedToScene=i.Node1.addedToScene&&i.Node2.addedToScene)}}},this.clearAllObjects=function(){this.Nodes=[],this.Edges=[],this.BackEdges=[]},this.setForegroundColor=function(t,s){null!=this.Nodes[t]&&void 0!=this.Nodes[t]&&this.Nodes[t].setForegroundColor(s)},this.setBackgroundColor=function(t,s){null!=this.Nodes[t]&&this.Nodes[t].setBackgroundColor(s)},this.setHighlight=function(t,s){null!=this.Nodes[t]&&void 0!=this.Nodes[t]&&this.Nodes[t].setHighlight(s)},this.getHighlight=function(t){return null==this.Nodes[t]||void 0==this.Nodes[t]?!1:this.Nodes[t].getHighlight()},this.setWidth=function(t,s){null!=this.Nodes[t]&&void 0!=this.Nodes[t]&&this.Nodes[t].setWidth(s)},this.setHeight=function(t,s){null!=this.Nodes[t]&&void 0!=this.Nodes[t]&&this.Nodes[t].setHeight(s)},this.getHeight=function(t){return null==this.Nodes[t]||void 0==this.Nodes[t]?-1:this.Nodes[t].getHeight()},this.getWidth=function(t){return null==this.Nodes[t]||void 0==this.Nodes[t]?-1:this.Nodes[t].getWidth()},this.backgroundColor=function(t){return null!=this.Nodes[t]?this.Nodes[t].backgroundColor:"#000000"},this.foregroundColor=function(t){return null!=this.Nodes[t]?this.Nodes[t].foregroundColor:"#000000"},this.disconnect=function(t,s){var e,i=null;if(null!=this.Edges[t]){var d=this.Edges[t].length;for(e=d-1;e>=0;e--)if(null!=this.Edges[t][e]&&this.Edges[t][e].Node2==this.Nodes[s]){var h=this.Edges[t][e];i=h.createUndoDisconnect(),this.Edges[t][e]=this.Edges[t][d-1],d-=1,this.Edges[t].pop()}}if(null!=this.BackEdges[s])for(d=this.BackEdges[s].length,e=d-1;e>=0;e--)null!=this.BackEdges[s][e]&&this.BackEdges[s][e].Node1==this.Nodes[t]&&(h=this.BackEdges[s][e],this.BackEdges[s][e]=this.BackEdges[s][d-1],d-=1,this.BackEdges[s].pop());return i},this.deleteIncident=function(t){var s=[];if(null!=this.Edges[t]){for(var e=this.Edges[t].length,i=e-1;i>=0;i--){var d=this.Edges[t][i],h=d.Node2.identifier();s.push(d.createUndoDisconnect());for(var o=this.BackEdges[h].length,n=o-1;n>=0;n--)this.BackEdges[h][n]==d&&(this.BackEdges[h][n]=this.BackEdges[h][o-1],o-=1,this.BackEdges[h].pop())}this.Edges[t]=null}if(null!=this.BackEdges[t]){for(e=this.BackEdges[t].length,i=e-1;i>=0;i--){d=this.BackEdges[t][i];var l=d.Node1.identifier();for(s.push(d.createUndoDisconnect()),o=this.Edges[l].length,n=o-1;n>=0;n--)this.Edges[l][n]==d&&(this.Edges[l][n]=this.Edges[l][o-1],o-=1,this.Edges[l].pop())}this.BackEdges[t]=null}return s},this.removeObject=function(t){this.Nodes[t];t==this.Nodes.length-1?this.Nodes.pop():this.Nodes[t]=null},this.getObject=function(t){if(null==this.Nodes[t]||void 0==this.Nodes[t])throw"getObject:Object with ID ("+String(t)+") does not exist";return this.Nodes[t]},this.addCircleObject=function(t,s){if(null!=this.Nodes[t]&&void 0!=this.Nodes[t])throw"addCircleObject:Object with same ID ("+String(t)+") already Exists!";var e=new AnimatedCircle(t,s);this.Nodes[t]=e},this.getNodeX=function(t){if(null==this.Nodes[t]||void 0==this.Nodes[t])throw"getting x position of an object that does not exit";return this.Nodes[t].x},this.getTextWidth=function(t){this.ctx.font="10px sans-serif",void 0==t&&(w=3);var s=t.split("\n"),e=0;if(1==s.length)e=this.ctx.measureText(t).width;else for(var i=0;i<s.length;i++)e=Math.max(e,this.ctx.measureText(s[i]).width);return e},this.setText=function(t,s,e){null!=this.Nodes[t]&&void 0!=this.Nodes[t]&&this.Nodes[t].setText(s,e,this.getTextWidth(s))},this.getText=function(t,s){if(null==this.Nodes[t]||void 0==this.Nodes[t])throw"getting text of an object that does not exit";return this.Nodes[t].getText(s)},this.getNodeY=function(t){if(null==this.Nodes[t]||void 0==this.Nodes[t])throw"getting y position of an object that does not exit";return this.Nodes[t].y},this.connectEdge=function(t,s,e,i,d,h,o){var n=this.Nodes[t],l=this.Nodes[s];if(null==n||null==l)throw"Tried to connect two nodes, one didn't exist!";var g=new Line(n,l,e,i,d,h,o);(null==this.Edges[t]||void 0==this.Edges[t])&&(this.Edges[t]=[]),(null==this.BackEdges[s]||void 0==this.BackEdges[s])&&(this.BackEdges[s]=[]),g.addedToScene=n.addedToScene&&l.addedToScene,this.Edges[t].push(g),this.BackEdges[s].push(g)},this.setNull=function(t,s){null!=this.Nodes[t]&&void 0!=this.Nodes[t]&&this.Nodes[t].setNull(s)},this.getNull=function(t){return null!=this.Nodes[t]&&void 0!=this.Nodes[t]?this.Nodes[t].getNull():!1},this.setEdgeColor=function(t,s,e){var i="#000000";if(null!=this.Edges[t]&&void 0!=this.Edges[t])for(var d=this.Edges[t].length,h=d-1;h>=0;h--)null!=this.Edges[t][h]&&void 0!=this.Edges[t][h]&&this.Edges[t][h].Node2==this.Nodes[s]&&(i=this.Edges[t][h].color(),this.Edges[t][h].setColor(e));return i},this.alignTop=function(t,s){if(null==this.Nodes[t]||void 0==this.Nodes[t]||null==this.Nodes[s]||void 0==this.Nodes[s])throw"Tring to align two nodes, one doesn't exist: "+String(t)+","+String(s);this.Nodes[t].alignTop(this.Nodes[s])},this.alignLeft=function(t,s){if(null==this.Nodes[t]||void 0==this.Nodes[t]||null==this.Nodes[s]||void 0==this.Nodes[s])throw"Tring to align two nodes, one doesn't exist: "+String(t)+","+String(s);this.Nodes[t].alignLeft(this.Nodes[s])},this.alignRight=function(t,s){if(null==this.Nodes[t]||void 0==this.Nodes[t]||null==this.Nodes[s]||void 0==this.Nodes[s])throw"Tring to align two nodes, one doesn't exist: "+String(t)+","+String(s);this.Nodes[t].alignRight(this.Nodes[s])},this.alignBottom=function(t,s){if(null==this.Nodes[t]||void 0==this.Nodes[t]||null==this.Nodes[s]||void 0==this.Nodes[s])throw"Tring to align two nodes, one doesn't exist: "+String(t)+","+String(s);this.Nodes[t].alignBottom(this.Nodes[s])},this.setEdgeHighlight=function(t,s,e){var i=!1;if(null!=this.Edges[t]&&void 0!=this.Edges[t])for(var d=this.Edges[t].length,h=d-1;h>=0;h--)null!=this.Edges[t][h]&&void 0!=this.Edges[t][h]&&this.Edges[t][h].Node2==this.Nodes[s]&&(i=this.Edges[t][h].highlighted,this.Edges[t][h].setHighlight(e));return i},this.addLabelObject=function(t,s,e){if(null!=this.Nodes[t]&&void 0!=this.Nodes[t])throw new Error("addLabelObject: Object Already Exists!");var i=new AnimatedLabel(t,s,e,this.getTextWidth(s));this.Nodes[t]=i},this.addLinkedListObject=function(t,s,e,i,d,h,o,n,l,g){if(null!=this.Nodes[t])throw new Error("addLinkedListObject:Object with same ID already Exists!");var r=new AnimatedLinkedList(t,s,e,i,d,h,o,n,l,g);this.Nodes[t]=r},this.getNumElements=function(t){return this.Nodes[t].getNumElements()},this.setNumElements=function(t,s){this.Nodes[t].setNumElements(s)},this.addBTreeNode=function(t,s,e,i,d,h){if(d=void 0==d?"#FFFFFF":d,h=void 0==h?"#FFFFFF":h,null!=this.Nodes[t]&&void 0!=Nodes[t])throw"addBTreeNode:Object with same ID already Exists!";var o=new AnimatedBTreeNode(t,s,e,i,d,h);this.Nodes[t]=o},this.addRectangleObject=function(t,s,e,i,d,h,o,n){if(null!=this.Nodes[t]||void 0!=this.Nodes[t])throw new Error("addRectangleObject:Object with same ID already Exists!");var l=new AnimatedRectangle(t,s,e,i,d,h,o,n);this.Nodes[t]=l},this.setNodePosition=function(t,s,e){null!=this.Nodes[t]&&void 0!=this.Nodes[t]&&void 0!=s&&void 0!=e&&(this.Nodes[t].x=s,this.Nodes[t].y=e)}}