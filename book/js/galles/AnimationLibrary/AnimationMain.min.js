// Copyright 2011 David Galles, University of San Francisco. All rights reserved.
//
// Redistribution and use in source and binary forms, with or without modification, are
// permitted provided that the following conditions are met:
//
// 1. Redistributions of source code must retain the above copyright notice, this list of
// conditions and the following disclaimer.
//
// 2. Redistributions in binary form must reproduce the above copyright notice, this list
// of conditions and the following disclaimer in the documentation and/or other materials
// provided with the distribution.
//
// THIS SOFTWARE IS PROVIDED BY <COPYRIGHT HOLDER> ``AS IS'' AND ANY EXPRESS OR IMPLIED
// WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
// FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL <COPYRIGHT HOLDER> OR
// CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
// CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
// SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
// ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
// ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
//
// The views and conclusions contained in the software and documentation are those of the
// authors and should not be interpreted as representing official policies, either expressed
// or implied, of the University of San Francisco

// Global timer used for doing animation callbacks.
//  TODO:  Make this an instance variable of Animation Manager.

function reorderSibling(t,e){t.parentNode.replaceChild(t,e),t.parentNode.insertBefore(e,t)}function swapControlDiv(){swapped=!swapped,swapped?(reorderSibling(document.getElementById("canvas"),document.getElementById("generalAnimationControlSection")),setCookie("VisualizationControlSwapped","true",30)):(reorderSibling(document.getElementById("generalAnimationControlSection"),document.getElementById("canvas")),setCookie("VisualizationControlSwapped","false",30))}function getCookie(t){var e,n,a,i=document.cookie.split(";");for(e=0;e<i.length;e++)if(n=i[e].substr(0,i[e].indexOf("=")),a=i[e].substr(i[e].indexOf("=")+1),n=n.replace(/^\s+|\s+$/g,""),n==t)return unescape(a)}function setCookie(t,e,n){var a=new Date;a.setDate(a.getDate()+n);escape(e)+(null==n?"":"; expires="+a.toUTCString());document.cookie=t+"="+e}function returnSubmit(t,e,n,a){return void 0!=n&&(t.size=n),function(i){var s=0;if(window.event?s=i.keyCode:i.which&&(s=i.which),13==s)e();else{if(59==s)return!1;if((void 0!=n&&t.value.length>=n||a&&(48>s||s>57))&&!controlKey(s))return!1}}}function animWaiting(){stepForwardButton.disabled=!1,0==skipBackButton.disabled&&(stepBackButton.disabled=!1),objectManager.statusReport.setText("Animacija je začasno ustavljena."),objectManager.statusReport.setForegroundColor("#FF0000")}function animStarted(){skipForwardButton.disabled=!1,skipBackButton.disabled=!1,stepForwardButton.disabled=!0,stepBackButton.disabled=!0,objectManager.statusReport.setText("Animacija se izvaja."),objectManager.statusReport.setForegroundColor("#009900")}function animEnded(){skipForwardButton.disabled=!0,stepForwardButton.disabled=!0,0==skipBackButton.disabled&&paused&&(stepBackButton.disabled=!1),objectManager.statusReport.setText("Animacija je zaključena."),objectManager.statusReport.setForegroundColor("#000000")}function anumUndoUnavailable(){skipBackButton.disabled=!0,stepBackButton.disabled=!0}function timeout(){timer=setTimeout("timeout()",30),animationManager.update(),objectManager.draw()}function doStep(){animationManager.step()}function doSkip(){animationManager.skipForward()}function doSkipBack(){animationManager.skipBack()}function doStepBack(){animationManager.stepBack()}function doPlayPause(){paused=!paused,paused?(playPauseBackButton.setAttribute("value","play"),playPauseBackButton.innerHTML="<span class='fa fa-play'</span>",0==skipBackButton.disabled&&(stepBackButton.disabled=!1)):(playPauseBackButton.setAttribute("value","pause"),playPauseBackButton.innerHTML="<span class='fa fa-pause'</span>"),animationManager.SetPaused(paused)}function addControl(t,e,n){var a=document.createElement("input");a.setAttribute("type",t),a.setAttribute("value",e);var i=document.createElement("td");i.appendChild(a);var s=document.getElementById(i);return s.appendChild(a),a}function addControlToAnimationBar(t,e,n){void 0==n&&(n="input");var a=document.createElement(n);a.setAttribute("type",t),a.setAttribute("value",e),"Text"!==t&&a.setAttribute("class","btn btn-info");var i=document.createElement("td");i.style.padding="2px",i.appendChild(a);var s=document.getElementById("GeneralAnimationControls");return s.appendChild(i),a}function addButtonToAnimationBar(t){var e=document.createElement("button");e.setAttribute("value",t),e.setAttribute("class","btn btn-info"),e.style.width="48px",e.innerHTML="<span class='fa fa-"+t+"'</span>";var n=document.createElement("td");n.style.padding="2px",n.appendChild(e);var a=document.getElementById("GeneralAnimationControls");return a.appendChild(n),e}function initCanvas(){canvas=document.getElementById("canvas"),objectManager=new ObjectManager,animationManager=new AnimationManager(objectManager),skipBackButton=addButtonToAnimationBar("fast-backward"),skipBackButton.onclick=animationManager.skipBack.bind(animationManager),stepBackButton=addButtonToAnimationBar("step-backward"),stepBackButton.onclick=animationManager.stepBack.bind(animationManager),playPauseBackButton=addButtonToAnimationBar("pause"),playPauseBackButton.onclick=doPlayPause,stepForwardButton=addButtonToAnimationBar("step-forward"),stepForwardButton.onclick=animationManager.step.bind(animationManager),skipForwardButton=addButtonToAnimationBar("fast-forward"),skipForwardButton.onclick=animationManager.skipForward.bind(animationManager);var t=document.createElement("div");t.setAttribute("display","inline-block"),t.setAttribute("float","left");var e=document.createElement("td"),n=document.getElementById("GeneralAnimationControls"),a=document.createElement("table"),i=document.createElement("tr"),s=document.createElement("td");i.appendChild(s),s.appendChild(t),a.appendChild(i),i=document.createElement("tr"),s=document.createElement("td"),s.align="center";var o=document.createTextNode("Hitrost animacije");i.appendChild(s),s.appendChild(o),a.appendChild(i),e.appendChild(a),n.appendChild(e);var r=getCookie("VisualizationSpeed");r=null==r||""==r?ANIMATION_SPEED_DEFAULT:parseInt(r),$(t).slider({animate:!0,value:r,change:function(t,e){setCookie("VisualizationSpeed",String(e.value),30)},slide:function(t,e){animationManager.SetSpeed(e.value)}}),animationManager.SetSpeed(r),t.setAttribute("style","width:150px;margin-left:5px;");var d=getCookie("VisualizationWidth");d=null==d||""==d?canvas.width:parseInt(d);var h=getCookie("VisualizationHeight");h=null==h||""==h?canvas.height:parseInt(h);var c=getCookie("VisualizationControlSwapped");return swapped="true"==c,swapped&&reorderSibling(document.getElementById("canvas"),document.getElementById("generalAnimationControlSection")),canvas.width=d,canvas.height=h,animationManager.addListener("AnimationStarted",this,animStarted),animationManager.addListener("AnimationEnded",this,this.animEnded),animationManager.addListener("AnimationWaiting",this,this.animWaiting),animationManager.addListener("AnimationUndoUnavailable",this,this.anumUndoUnavailable),objectManager.width=canvas.width,objectManager.height=canvas.height,animationManager}function AnimationManager(t){this.animatedObjects=t,this.animationPaused=!1,this.awaitingStep=!1,this.currentlyAnimating=!1,this.AnimationSteps=[],this.currentAnimation=0,this.previousAnimationSteps=[],this.currFrame=0,this.animationBlockLength=0,this.currentBlock=null,this.undoStack=[],this.doingUndo=!1,this.undoAnimationStepIndices=[],this.undoAnimationStepIndicesStack=[],this.animationBlockLength=10,this.lerp=function(t,e,n){return(e-t)*n+t},this.SetPaused=function(t){this.animationPaused=t,this.animationPaused||this.step()},this.SetSpeed=function(t){this.animationBlockLength=Math.floor((100-t)/2)},this.parseBool=function(t){var e=t.toUpperCase(),n=!("False"==e||"f"==e||" 0"==e||"0"==e||""==e);return n},this.parseColor=function(t){return"#"==t.charAt(0)?t:"0x"==t.substring(0,2)?"#"+t.substring(2):void 0},this.changeSize=function(){var t=parseInt(widthEntry.value),e=parseInt(heightEntry.value);t>100&&(canvas.width=t,this.animatedObjects.width=t,setCookie("VisualizationWidth",String(t),30)),e>100&&(canvas.height=e,this.animatedObjects.height=e,setCookie("VisualizationHeight",String(e),30)),t.value=canvas.width,heightEntry.value=canvas.height,this.animatedObjects.draw(),this.fireEvent("CanvasSizeChanged",{width:canvas.width,height:canvas.height})},this.startNextBlock=function(){this.awaitingStep=!1,this.currentBlock=[];var t=[];if(this.currentAnimation==this.AnimationSteps.length)return this.currentlyAnimating=!1,this.awaitingStep=!1,this.fireEvent("AnimationEnded","NoData"),clearTimeout(timer),this.animatedObjects.update(),void this.animatedObjects.draw();this.undoAnimationStepIndices.push(this.currentAnimation);for(var e=!1,n=!1;this.currentAnimation<this.AnimationSteps.length&&!e;){var a=this.AnimationSteps[this.currentAnimation].split("<;>");if("CREATECIRCLE"==a[0].toUpperCase())this.animatedObjects.addCircleObject(parseInt(a[1]),a[2]),a.length>4&&this.animatedObjects.setNodePosition(parseInt(a[1]),parseInt(a[3]),parseInt(a[4])),t.push(new UndoCreate(parseInt(a[1])));else if("CONNECT"==a[0].toUpperCase())a.length>7?this.animatedObjects.connectEdge(parseInt(a[1]),parseInt(a[2]),this.parseColor(a[3]),parseFloat(a[4]),this.parseBool(a[5]),a[6],parseInt(a[7])):a.length>6?this.animatedObjects.connectEdge(parseInt(a[1]),parseInt(a[2]),this.parseColor(a[3]),parseFloat(a[4]),this.parseBool(a[5]),a[6],0):a.length>5?this.animatedObjects.connectEdge(parseInt(a[1]),parseInt(a[2]),this.parseColor(a[3]),parseFloat(a[4]),this.parseBool(a[5]),"",0):a.length>4?this.animatedObjects.connectEdge(parseInt(a[1]),parseInt(a[2]),this.parseColor(a[3]),parseFloat(a[4]),!0,"",0):a.length>3?this.animatedObjects.connectEdge(parseInt(a[1]),parseInt(a[2]),this.parseColor(a[3]),0,!0,"",0):this.animatedObjects.connectEdge(parseInt(a[1]),parseInt(a[2]),"#000000",0,!0,"",0),t.push(new UndoConnect(parseInt(a[1]),parseInt(a[2]),!1));else if("CREATERECTANGLE"==a[0].toUpperCase())9==a.length?this.animatedObjects.addRectangleObject(parseInt(a[1]),a[2],parseInt(a[3]),parseInt(a[4]),a[7],a[8],"#ffffff","#000000"):this.animatedObjects.addRectangleObject(parseInt(a[1]),a[2],parseInt(a[3]),parseInt(a[4]),"center","center","#ffffff","#000000"),a.length>6&&this.animatedObjects.setNodePosition(parseInt(a[1]),parseInt(a[5]),parseInt(a[6])),t.push(new UndoCreate(parseInt(a[1])));else if("MOVE"==a[0].toUpperCase()){var i=parseInt(a[1]),s=new SingleAnimation(i,this.animatedObjects.getNodeX(i),this.animatedObjects.getNodeY(i),parseInt(a[2]),parseInt(a[3]));this.currentBlock.push(s),t.push(new UndoMove(s.objectID,s.toX,s.toY,s.fromX,s.fromY)),n=!0}else if("STEP"==a[0].toUpperCase())e=!0;else if("SETFOREGROUNDCOLOR"==a[0].toUpperCase()){var o=parseInt(a[1]),r=this.animatedObjects.foregroundColor(o);this.animatedObjects.setForegroundColor(o,this.parseColor(a[2])),t.push(new UndoSetForegroundColor(o,r))}else if("SETBACKGROUNDCOLOR"==a[0].toUpperCase())o=parseInt(a[1]),r=this.animatedObjects.backgroundColor(o),this.animatedObjects.setBackgroundColor(o,this.parseColor(a[2])),t.push(new UndoSetBackgroundColor(o,r));else if("SETHIGHLIGHT"==a[0].toUpperCase()){var d=this.parseBool(a[2]);this.animatedObjects.setHighlight(parseInt(a[1]),d),t.push(new UndoHighlight(parseInt(a[1]),!d))}else if("DISCONNECT"==a[0].toUpperCase()){var h=this.animatedObjects.disconnect(parseInt(a[1]),parseInt(a[2]));null!=h&&t.push(h)}else if("SETALPHA"==a[0].toUpperCase()){var c=this.animatedObjects.getAlpha(parseInt(a[1]));this.animatedObjects.setAlpha(parseInt(a[1]),parseFloat(a[2])),t.push(new UndoSetAlpha(parseInt(a[1]),c))}else if("SETTEXT"==a[0].toUpperCase())if(a.length>3){var p=this.animatedObjects.getText(parseInt(a[1]),parseInt(a[3]));this.animatedObjects.setText(parseInt(a[1]),a[2],parseInt(a[3])),void 0!=p&&t.push(new UndoSetText(parseInt(a[1]),p,parseInt(a[3])))}else p=this.animatedObjects.getText(parseInt(a[1]),0),this.animatedObjects.setText(parseInt(a[1]),a[2],0),void 0!=p&&t.push(new UndoSetText(parseInt(a[1]),p,0));else if("DELETE"==a[0].toUpperCase()){var i=parseInt(a[1]),l=this.animatedObjects.deleteIncident(i);l.length>0&&(t=t.concat(l));var u=this.animatedObjects.getObject(i);null!=u&&(t.push(u.createUndoDelete()),this.animatedObjects.removeObject(i))}else if("CREATEHIGHLIGHTCIRCLE"==a[0].toUpperCase())a.length>5?this.animatedObjects.addHighlightCircleObject(parseInt(a[1]),this.parseColor(a[2]),parseFloat(a[5])):this.animatedObjects.addHighlightCircleObject(parseInt(a[1]),this.parseColor(a[2]),20),a.length>4&&this.animatedObjects.setNodePosition(parseInt(a[1]),parseInt(a[3]),parseInt(a[4])),t.push(new UndoCreate(parseInt(a[1])));else if("CREATELABEL"==a[0].toUpperCase())6==a.length?this.animatedObjects.addLabelObject(parseInt(a[1]),a[2],this.parseBool(a[5])):this.animatedObjects.addLabelObject(parseInt(a[1]),a[2],!0),a.length>=5&&this.animatedObjects.setNodePosition(parseInt(a[1]),parseFloat(a[3]),parseFloat(a[4])),t.push(new UndoCreate(parseInt(a[1])));else if("SETEDGECOLOR"==a[0].toUpperCase()){var m=parseInt(a[1]),g=parseInt(a[2]),b=this.parseColor(a[3]),r=this.animatedObjects.setEdgeColor(m,g,b);t.push(new UndoSetEdgeColor(m,g,r))}else if("SETEDGEALPHA"==a[0].toUpperCase()){var m=parseInt(a[1]),g=parseInt(a[2]),I=parseFloat(a[3]),B=this.animatedObjects.setEdgeAlpha(m,g,I);t.push(new UndoSetEdgeAlpha(m,g,B))}else if("SETEDGEHIGHLIGHT"==a[0].toUpperCase()){var d=this.parseBool(a[3]),m=parseInt(a[1]),g=parseInt(a[2]),k=this.animatedObjects.setEdgeHighlight(m,g,d);t.push(new UndoHighlightEdge(m,g,k))}else if("SETHEIGHT"==a[0].toUpperCase()){o=parseInt(a[1]);var f=this.animatedObjects.getHeight(o);this.animatedObjects.setHeight(o,parseInt(a[2])),t.push(new UndoSetHeight(o,f))}else if("SETLAYER"==a[0].toUpperCase())this.animatedObjects.setLayer(parseInt(a[1]),parseInt(a[2]));else if("CREATELINKEDLIST"==a[0].toUpperCase())11==a.length?this.animatedObjects.addLinkedListObject(parseInt(a[1]),a[2],parseInt(a[3]),parseInt(a[4]),parseFloat(a[7]),this.parseBool(a[8]),this.parseBool(a[9]),parseInt(a[10]),"#FFFFFF","#000000"):this.animatedObjects.addLinkedListObject(parseInt(a[1]),a[2],parseInt(a[3]),parseInt(a[4]),.25,!0,!1,1,"#FFFFFF","#000000"),a.length>6&&(this.animatedObjects.setNodePosition(parseInt(a[1]),parseInt(a[5]),parseInt(a[6])),t.push(new UndoCreate(parseInt(a[1]))));else if("SETNULL"==a[0].toUpperCase()){var j=this.animatedObjects.getNull(parseInt(a[1]));this.animatedObjects.setNull(parseInt(a[1]),this.parseBool(a[2])),t.push(new UndoSetNull(parseInt(a[1]),j))}else if("SETTEXTCOLOR"==a[0].toUpperCase())a.length>3?(r=this.animatedObjects.getTextColor(parseInt(a[1]),parseInt(a[3])),this.animatedObjects.setTextColor(parseInt(a[1]),this.parseColor(a[2]),parseInt(a[3])),t.push(new UndoSetTextColor(parseInt(a[1]),r,parseInt(a[3])))):(r=this.animatedObjects.getTextColor(parseInt(a[1]),0),this.animatedObjects.setTextColor(parseInt(a[1]),this.parseColor(a[2]),0),t.push(new UndoSetTextColor(parseInt(a[1]),r,0)));else if("CREATEBTREENODE"==a[0].toUpperCase())this.animatedObjects.addBTreeNode(parseInt(a[1]),parseFloat(a[2]),parseFloat(a[3]),parseInt(a[4]),this.parseColor(a[7]),this.parseColor(a[8])),this.animatedObjects.setNodePosition(parseInt(a[1]),parseInt(a[5]),parseInt(a[6])),t.push(new UndoCreate(parseInt(a[1])));else if("SETWIDTH"==a[0].toUpperCase()){var o=parseInt(a[1]);this.animatedObjects.setWidth(o,parseInt(a[2]));var A=this.animatedObjects.getWidth(o);t.push(new UndoSetWidth(o,A))}else if("SETNUMELEMENTS"==a[0].toUpperCase()){var S=this.animatedObjects.getObject(parseInt(a[1]));t.push(new UndoSetNumElements(S,parseInt(a[2]))),this.animatedObjects.setNumElements(parseInt(a[1]),parseInt(a[2]))}else if("SETPOSITION"==a[0].toUpperCase()){var o=parseInt(a[1]),O=this.animatedObjects.getNodeX(o),C=this.animatedObjects.getNodeY(o);t.push(new UndoSetPosition(o,O,C)),this.animatedObjects.setNodePosition(o,parseInt(a[2]),parseInt(a[3]))}else if("ALIGNRIGHT"==a[0].toUpperCase()){var o=parseInt(a[1]),O=this.animatedObjects.getNodeX(o),C=this.animatedObjects.getNodeY(o);t.push(new UndoSetPosition(o,O.oldY)),this.animatedObjects.alignRight(o,parseInt(a[2]))}else if("ALIGNLEFT"==a[0].toUpperCase()){var o=parseInt(a[1]),O=this.animatedObjects.getNodeX(o),C=this.animatedObjects.getNodeY(o);t.push(new UndoSetPosition(o,O.oldY)),this.animatedObjects.alignLeft(o,parseInt(a[2]))}else if("ALIGNTOP"==a[0].toUpperCase()){var o=parseInt(a[1]),O=this.animatedObjects.getNodeX(o),C=this.animatedObjects.getNodeY(o);t.push(new UndoSetPosition(o,O.oldY)),this.animatedObjects.alignTop(o,parseInt(a[2]))}else if("ALIGNBOTTOM"==a[0].toUpperCase()){var o=parseInt(a[1]),O=this.animatedObjects.getNodeX(o),C=this.animatedObjects.getNodeY(o);t.push(new UndoSetPosition(o,O.oldY)),this.animatedObjects.alignBottom(o,parseInt(a[2]))}this.currentAnimation=this.currentAnimation+1}this.currFrame=0,(!n&&this.animationPaused||!n&&this.currentAnimation==this.AnimationSteps.length)&&(this.currFrame=this.animationBlockLength),this.undoStack.push(t)},this.StartNewAnimation=function(t){clearTimeout(timer),null!=this.AnimationSteps&&(this.previousAnimationSteps.push(this.AnimationSteps),this.undoAnimationStepIndicesStack.push(this.undoAnimationStepIndices)),void 0==t||0==t.length?this.AnimationSteps=["Step"]:this.AnimationSteps=t,this.undoAnimationStepIndices=new Array,this.currentAnimation=0,this.startNextBlock(),this.currentlyAnimating=!0,this.fireEvent("AnimationStarted","NoData"),timer=setTimeout("timeout()",30)},this.stepBack=function(){this.awaitingStep&&null!=this.undoStack&&0!=this.undoStack.length?(this.fireEvent("AnimationStarted","NoData"),clearTimeout(timer),this.awaitingStep=!1,this.undoLastBlock(),clearTimeout(timer),timer=setTimeout("timeout()",30)):!this.currentlyAnimating&&this.animationPaused&&null!=this.undoAnimationStepIndices&&(this.fireEvent("AnimationStarted","NoData"),this.currentlyAnimating=!0,this.undoLastBlock(),clearTimeout(timer),timer=setTimeout("timeout()",30))},this.step=function(){this.awaitingStep&&(this.startNextBlock(),this.fireEvent("AnimationStarted","NoData"),this.currentlyAnimating=!0,clearTimeout(timer),timer=setTimeout("timeout()",30))},this.clearHistory=function(){this.undoStack=[],this.undoAnimationStepIndices=null,this.previousAnimationSteps=[],this.undoAnimationStepIndicesStack=[],this.AnimationSteps=null,this.fireEvent("AnimationUndoUnavailable","NoData"),clearTimeout(timer),this.animatedObjects.update(),this.animatedObjects.draw()},this.skipBack=function(){var t=null!=this.undoAnimationStepIndices&&0!=this.undoAnimationStepIndices.length;if(t){var e;for(e=0;null!=this.currentBlock&&e<this.currentBlock.length;e++){var n=this.currentBlock[e].objectID;this.animatedObjects.setNodePosition(n,this.currentBlock[e].toX,this.currentBlock[e].toY)}for(this.doingUndo&&this.finishUndoBlock(this.undoStack.pop());t;){for(this.undoLastBlock(),e=0;e<this.currentBlock.length;e++)n=this.currentBlock[e].objectID,this.animatedObjects.setNodePosition(n,this.currentBlock[e].toX,this.currentBlock[e].toY);t=this.finishUndoBlock(this.undoStack.pop())}clearTimeout(timer),this.animatedObjects.update(),this.animatedObjects.draw(),(null==this.undoStack||0==this.undoStack.length)&&this.fireEvent("AnimationUndoUnavailable","NoData")}},this.resetAll=function(){this.clearHistory(),this.animatedObjects.clearAllObjects(),this.animatedObjects.draw(),clearTimeout(timer)},this.skipForward=function(){if(this.currentlyAnimating){for(this.animatedObjects.runFast=!0;null!=this.AnimationSteps&&this.currentAnimation<this.AnimationSteps.length;){var t;for(t=0;null!=this.currentBlock&&t<this.currentBlock.length;t++){var e=this.currentBlock[t].objectID;this.animatedObjects.setNodePosition(e,this.currentBlock[t].toX,this.currentBlock[t].toY)}for(this.doingUndo&&this.finishUndoBlock(this.undoStack.pop()),this.startNextBlock(),t=0;t<this.currentBlock.length;t++){var e=this.currentBlock[t].objectID;this.animatedObjects.setNodePosition(e,this.currentBlock[t].toX,this.currentBlock[t].toY)}}this.animatedObjects.update(),this.currentlyAnimating=!1,this.awaitingStep=!1,this.doingUndo=!1,this.animatedObjects.runFast=!1,this.fireEvent("AnimationEnded","NoData"),clearTimeout(timer),this.animatedObjects.update(),this.animatedObjects.draw()}},this.finishUndoBlock=function(t){for(var e=t.length-1;e>=0;e--)t[e].undoInitialStep(this.animatedObjects);return this.doingUndo=!1,0==this.undoAnimationStepIndices.length?(this.awaitingStep=!1,this.currentlyAnimating=!1,this.undoAnimationStepIndices=this.undoAnimationStepIndicesStack.pop(),this.AnimationSteps=this.previousAnimationSteps.pop(),this.fireEvent("AnimationEnded","NoData"),this.fireEvent("AnimationUndo","NoData"),this.currentBlock=[],(null==this.undoStack||0==this.undoStack.length)&&(this.currentlyAnimating=!1,this.awaitingStep=!1,this.fireEvent("AnimationUndoUnavailable","NoData")),clearTimeout(timer),this.animatedObjects.update(),this.animatedObjects.draw(),!1):!0},this.undoLastBlock=function(){if(0!=this.undoAnimationStepIndices.length&&this.undoAnimationStepIndices.length>0){this.doingUndo=!0;var t=!1;this.currentAnimation=this.undoAnimationStepIndices.pop(),this.currentBlock=[];var e,n=this.undoStack[this.undoStack.length-1];for(e=n.length-1;e>=0;e--){var a=n[e].addUndoAnimation(this.currentBlock);t=t||a}this.currFrame=0,!t&&this.animationPaused&&(this.currFrame=this.animationBlockLength),this.currentlyAnimating=!0}},this.setLayer=function(t,e){this.animatedObjects.setLayer(t,e),this.animatedObjects.draw()},this.setAllLayers=function(t){this.animatedObjects.setAllLayers(t),this.animatedObjects.draw()},this.update=function(){if(this.currentlyAnimating){this.currFrame=this.currFrame+1;var t;for(t=0;t<this.currentBlock.length;t++)if(this.currFrame==this.animationBlockLength||1==this.currFrame&&0==this.animationBlockLength)this.animatedObjects.setNodePosition(this.currentBlock[t].objectID,this.currentBlock[t].toX,this.currentBlock[t].toY);else if(this.currFrame<this.animationBlockLength){var e=this.currentBlock[t].objectID,n=1/(this.animationBlockLength-this.currFrame),a=(this.animatedObjects.getNodeX(e),this.animatedObjects.getNodeY(e),this.currentBlock[t].toX,this.currentBlock[t].toY,this.lerp(this.animatedObjects.getNodeX(e),this.currentBlock[t].toX,n)),i=this.lerp(this.animatedObjects.getNodeY(e),this.currentBlock[t].toY,n);this.animatedObjects.setNodePosition(e,a,i)}this.currFrame>=this.animationBlockLength&&(this.doingUndo?this.finishUndoBlock(this.undoStack.pop())&&(this.awaitingStep=!0,this.fireEvent("AnimationWaiting","NoData")):this.animationPaused&&this.currentAnimation<this.AnimationSteps.length?(this.awaitingStep=!0,this.fireEvent("AnimationWaiting","NoData"),this.currentBlock=[]):this.startNextBlock()),this.animatedObjects.update()}}}function SingleAnimation(t,e,n,a,i){this.objectID=t,this.fromX=e,this.fromY=n,this.toX=a,this.toY=i}var timer,swapped=!1,ANIMATION_SPEED_DEFAULT=75,objectManager,animationManager,canvas,paused=!1,playPauseBackButton,skipBackButton,stepBackButton,stepForwardButton,skipForwardButton,widthEntry,heightEntry,sizeButton;AnimationManager.prototype=new EventListener,AnimationManager.prototype.constructor=AnimationManager;