// Copyright 2011 David Galles, University of San Francisco. All rights reserved.
//
// Redistribution and use in source and binary forms, with or without modification, are
// permitted provided that the following conditions are met:
//
// 1. Redistributions of source code must retain the above copyright notice, this list of
// conditions and the following disclaimer.
//
// 2. Redistributions in binary form must reproduce the above copyright notice, this list
// of conditions and the following disclaimer in the documentation and/or other materials
// provided with the distribution.
//
// THIS SOFTWARE IS PROVIDED BY <COPYRIGHT HOLDER> ``AS IS'' AND ANY EXPRESS OR IMPLIED
// WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
// FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL <COPYRIGHT HOLDER> OR
// CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
// CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
// SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
// ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
// NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
// ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
//
// The views and conclusions contained in the software and documentation are those of the
// authors and should not be interpreted as representing official policies, either expressed
// or implied, of the University of San Francisco


// Object Manager
//
// Manage all of our animated objects.  Control any animated object should occur through
// this interface (not language enforced, because enforcing such things in Javascript is 
// problematic.)
//
// This class is only accessed through:
//
//  AnimationMain
//  Undo objects (which are themselves controlled by AnimationMain


// TODO: 
//       1.  Add proper throws for all error conditions (perhaps guarded by
//           an assert-like structure that can be turned off for production?)
//       2.  Refactor this code so that it uses the same object syntax (with 
//           prototypes) as te rest of the code.  (low priority)

function ObjectManager(){this.Nodes=[];this.Edges=[];this.BackEdges=[];this.activeLayers=[];this.activeLayers[0]=true;this.ctx=document.getElementById("canvas").getContext("2d");this.framenum=0;this.width=0;this.height=0;this.draw=function(){this.framenum++;if(this.framenum>1e3)this.framenum=0;this.ctx.clearRect(0,0,this.width,this.height);var e;var t;for(e=0;e<this.Nodes.length;e++){if(this.Nodes[e]!=null&&!this.Nodes[e].highlighted&&this.Nodes[e].addedToScene){this.Nodes[e].draw(this.ctx)}}for(e=0;e<this.Nodes.length;e++){if(this.Nodes[e]!=null&&this.Nodes[e].highlighted&&this.Nodes[e].addedToScene){this.Nodes[e].pulseHighlight(this.framenum);this.Nodes[e].draw(this.ctx)}}for(e=0;e<this.Edges.length;e++){if(this.Edges[e]!=null){for(t=0;t<this.Edges[e].length;t++){if(this.Edges[e][t].addedToScene){this.Edges[e][t].pulseHighlight(this.framenum);this.Edges[e][t].draw(this.ctx)}}}}};this.update=function(){};this.setLayers=function(e,t){for(var n=0;n<t.length;n++){this.activeLayers[t[n]]=e}this.resetLayers()};this.addHighlightCircleObject=function(e,t,n){if(this.Nodes[e]!=null&&this.Nodes[e]!=undefined){}var r=new HighlightCircle(e,t,n);this.Nodes[e]=r};this.setEdgeAlpha=function(e,t,n){var r=1;if(this.Edges[e]!=null&&this.Edges[e]!=undefined){var i=this.Edges[e].length;for(var s=i-1;s>=0;s--){if(this.Edges[e][s]!=null&&this.Edges[e][s]!=undefined&&this.Edges[e][s].Node2==this.Nodes[t]){r=this.Edges[e][s].alpha;this.Edges[e][s].alpha=n}}}return r};this.setAlpha=function(e,t){if(this.Nodes[e]!=null&&this.Nodes[e]!=undefined){this.Nodes[e].setAlpha(t)}};this.getAlpha=function(e){if(this.Nodes[e]!=null&&this.Nodes[e]!=undefined){return this.Nodes[e].getAlpha()}else{return-1}};this.getTextColor=function(e,t){if(this.Nodes[e]!=null&&this.Nodes[e]!=undefined){return this.Nodes[e].getTextColor(t)}else{return"#000000"}};this.setTextColor=function(e,t,n){if(this.Nodes[e]!=null&&this.Nodes[e]!=undefined){this.Nodes[e].setTextColor(t,n)}};this.setAllLayers=function(e){this.activeLayers=[];for(var t=0;t<e.length;t++){this.activeLayers[e[t]]=true}this.resetLayers()};this.resetLayers=function(){var e;for(e=0;e<this.Nodes.length;e++){if(this.Nodes[e]!=null&&this.Nodes[e]!=undefined){this.Nodes[e].addedToScene=this.activeLayers[this.Nodes[e].layer]==true}}for(e=this.Edges.length-1;e>=0;e--){if(this.Edges[e]!=null&&this.Edges[e]!=undefined){for(var t=0;t<this.Edges[e].length;t++){if(this.Edges[e][t]!=null&&this.Edges[e][t]!=undefined){this.Edges[e][t].addedToScene=this.activeLayers[this.Edges[e][t].Node1.layer]==true&&this.activeLayers[this.Edges[e][t].Node2.layer]==true}}}}};this.setLayer=function(e,t){if(this.Nodes[e]!=null&&this.Nodes[e]!=undefined){this.Nodes[e].layer=t;if(this.activeLayers[t]){this.Nodes[e].addedToScene=true}else{this.Nodes[e].addedToScene=false}if(this.Edges[e]!=null&&this.Edges[e]!=undefined){for(var n=0;n<this.Edges[e].length;n++){var r=this.Edges[e][n];if(r!=null&&r!=undefined){r.addedToScene=r.Node1.addedToScene&&r.Node2.addedToScene}}}if(this.BackEdges[e]!=null&&this.BackEdges[e]!=undefined){for(var n=0;n<this.BackEdges[e].length;n++){var r=this.BackEdges[e][n];if(r!=null&&r!=undefined){r.addedToScene=r.Node1.addedToScene&&r.Node2.addedToScene}}}}};this.clearAllObjects=function(){this.Nodes=[];this.Edges=[];this.BackEdges=[]};this.setForegroundColor=function(e,t){if(this.Nodes[e]!=null&&this.Nodes[e]!=undefined){this.Nodes[e].setForegroundColor(t)}};this.setBackgroundColor=function(e,t){if(this.Nodes[e]!=null){this.Nodes[e].setBackgroundColor(t)}};this.setHighlight=function(e,t){if(this.Nodes[e]==null||this.Nodes[e]==undefined){return}this.Nodes[e].setHighlight(t)};this.getHighlight=function(e){if(this.Nodes[e]==null||this.Nodes[e]==undefined){return false}return this.Nodes[e].getHighlight()};this.setWidth=function(e,t){if(this.Nodes[e]==null||this.Nodes[e]==undefined){return}this.Nodes[e].setWidth(t)};this.setHeight=function(e,t){if(this.Nodes[e]==null||this.Nodes[e]==undefined){return}this.Nodes[e].setHeight(t)};this.getHeight=function(e){if(this.Nodes[e]==null||this.Nodes[e]==undefined){return-1}return this.Nodes[e].getHeight()};this.getWidth=function(e){if(this.Nodes[e]==null||this.Nodes[e]==undefined){return-1}return this.Nodes[e].getWidth(val)};this.backgroundColor=function(e){if(this.Nodes[e]!=null){return this.Nodes[e].backgroundColor}else{return"#000000"}};this.foregroundColor=function(e){if(this.Nodes[e]!=null){return this.Nodes[e].foregroundColor}else{return"#000000"}};this.disconnect=function(e,t){var n=null;var r;if(this.Edges[e]!=null){var i=this.Edges[e].length;for(r=i-1;r>=0;r--){if(this.Edges[e][r]!=null&&this.Edges[e][r].Node2==this.Nodes[t]){var s=this.Edges[e][r];n=s.createUndoDisconnect();this.Edges[e][r]=this.Edges[e][i-1];i-=1;this.Edges[e].pop()}}}if(this.BackEdges[t]!=null){i=this.BackEdges[t].length;for(r=i-1;r>=0;r--){if(this.BackEdges[t][r]!=null&&this.BackEdges[t][r].Node1==this.Nodes[e]){s=this.BackEdges[t][r];this.BackEdges[t][r]=this.BackEdges[t][i-1];i-=1;this.BackEdges[t].pop()}}}return n};this.deleteIncident=function(e){var t=[];if(this.Edges[e]!=null){var n=this.Edges[e].length;for(var r=n-1;r>=0;r--){var i=this.Edges[e][r];var s=i.Node2.identifier();t.push(i.createUndoDisconnect());var o=this.BackEdges[s].length;for(var u=o-1;u>=0;u--){if(this.BackEdges[s][u]==i){this.BackEdges[s][u]=this.BackEdges[s][o-1];o-=1;this.BackEdges[s].pop()}}}this.Edges[e]=null}if(this.BackEdges[e]!=null){n=this.BackEdges[e].length;for(r=n-1;r>=0;r--){i=this.BackEdges[e][r];var a=i.Node1.identifier();t.push(i.createUndoDisconnect());o=this.Edges[a].length;for(u=o-1;u>=0;u--){if(this.Edges[a][u]==i){this.Edges[a][u]=this.Edges[a][o-1];o-=1;this.Edges[a].pop()}}}this.BackEdges[e]=null}return t};this.removeObject=function(e){var t=this.Nodes[e];if(e==this.Nodes.length-1){this.Nodes.pop()}else{this.Nodes[e]=null}};this.getObject=function(e){if(this.Nodes[e]==null||this.Nodes[e]==undefined){throw"getObject:Object with ID ("+String(e)+") does not exist"}return this.Nodes[e]};this.addCircleObject=function(e,t){if(this.Nodes[e]!=null&&this.Nodes[e]!=undefined){throw"addCircleObject:Object with same ID ("+String(e)+") already Exists!"}var n=new AnimatedCircle(e,t);this.Nodes[e]=n};this.getNodeX=function(e){if(this.Nodes[e]==null||this.Nodes[e]==undefined){throw"getting x position of an object that does not exit"}return this.Nodes[e].x};this.getTextWidth=function(e){this.ctx.font="10px sans-serif";var t=e.split("\n");var n=0;if(t.length==1){n=this.ctx.measureText(e).width}else{for(var r=0;r<t.length;r++){n=Math.max(n,this.ctx.measureText(t[r]).width)}}return n};this.setText=function(e,t,n){if(this.Nodes[e]==null||this.Nodes[e]==undefined){return;throw"setting text of an object that does not exit"}this.Nodes[e].setText(t,n,this.getTextWidth(t))};this.getText=function(e,t){if(this.Nodes[e]==null||this.Nodes[e]==undefined){throw"getting text of an object that does not exit"}return this.Nodes[e].getText(t)};this.getNodeY=function(e){if(this.Nodes[e]==null||this.Nodes[e]==undefined){throw"getting y position of an object that does not exit"}return this.Nodes[e].y};this.connectEdge=function(e,t,n,r,i,s,o){var u=this.Nodes[e];var a=this.Nodes[t];if(u==null||a==null){throw"Tried to connect two nodes, one didn't exist!"}var f=new Line(u,a,n,r,i,s,o);if(this.Edges[e]==null||this.Edges[e]==undefined){this.Edges[e]=[]}if(this.BackEdges[t]==null||this.BackEdges[t]==undefined){this.BackEdges[t]=[]}f.addedToScene=u.addedToScene&&a.addedToScene;this.Edges[e].push(f);this.BackEdges[t].push(f)};this.setNull=function(e,t){if(this.Nodes[e]!=null&&this.Nodes[e]!=undefined){this.Nodes[e].setNull(t)}};this.getNull=function(e){if(this.Nodes[e]!=null&&this.Nodes[e]!=undefined){return this.Nodes[e].getNull()}return false};this.setEdgeColor=function(e,t,n){var r="#000000";if(this.Edges[e]!=null&&this.Edges[e]!=undefined){var i=this.Edges[e].length;for(var s=i-1;s>=0;s--){if(this.Edges[e][s]!=null&&this.Edges[e][s]!=undefined&&this.Edges[e][s].Node2==this.Nodes[t]){r=this.Edges[e][s].color();this.Edges[e][s].setColor(n)}}}return r};this.alignTop=function(e,t){if(this.Nodes[e]==null||this.Nodes[e]==undefined||this.Nodes[t]==null||this.Nodes[t]==undefined){throw"Tring to align two nodes, one doesn't exist: "+String(e)+","+String(t)}this.Nodes[e].alignTop(this.Nodes[t])};this.alignLeft=function(e,t){if(this.Nodes[e]==null||this.Nodes[e]==undefined||this.Nodes[t]==null||this.Nodes[t]==undefined){throw"Tring to align two nodes, one doesn't exist: "+String(e)+","+String(t)}this.Nodes[e].alignLeft(this.Nodes[t])};this.alignRight=function(e,t){if(this.Nodes[e]==null||this.Nodes[e]==undefined||this.Nodes[t]==null||this.Nodes[t]==undefined){throw"Tring to align two nodes, one doesn't exist: "+String(e)+","+String(t)}this.Nodes[e].alignRight(this.Nodes[t])};this.alignBottom=function(e,t){if(this.Nodes[e]==null||this.Nodes[e]==undefined||this.Nodes[t]==null||this.Nodes[t]==undefined){throw"Tring to align two nodes, one doesn't exist: "+String(e)+","+String(t)}this.Nodes[e].alignBottom(this.Nodes[t])};this.setEdgeHighlight=function(e,t,n){var r=false;if(this.Edges[e]!=null&&this.Edges[e]!=undefined){var i=this.Edges[e].length;for(var s=i-1;s>=0;s--){if(this.Edges[e][s]!=null&&this.Edges[e][s]!=undefined&&this.Edges[e][s].Node2==this.Nodes[t]){r=this.Edges[e][s].highlighted;this.Edges[e][s].setHighlight(n)}}}return r};this.addLabelObject=function(e,t,n){if(this.Nodes[e]!=null&&this.Nodes[e]!=undefined){throw new Error("addLabelObject: Object Already Exists!")}var r=new AnimatedLabel(e,t,n,this.getTextWidth(t));this.Nodes[e]=r};this.addLinkedListObject=function(e,t,n,r,i,s,o,u,a,f){if(this.Nodes[e]!=null){throw new Error("addLinkedListObject:Object with same ID already Exists!");return}var l=new AnimatedLinkedList(e,t,n,r,i,s,o,u,a,f);this.Nodes[e]=l};this.getNumElements=function(e){return this.Nodes[e].getNumElements()};this.setNumElements=function(e,t){this.Nodes[e].setNumElements(t)};this.addBTreeNode=function(e,t,n,r,i,s){i=i==undefined?"#FFFFFF":i;s=s==undefined?"#FFFFFF":s;if(this.Nodes[e]!=null&&Nodes[e]!=undefined){throw"addBTreeNode:Object with same ID already Exists!"}var o=new AnimatedBTreeNode(e,t,n,r,i,s);this.Nodes[e]=o};this.addRectangleObject=function(e,t,n,r,i,s,o,u){if(this.Nodes[e]!=null||this.Nodes[e]!=undefined){throw new Error("addRectangleObject:Object with same ID already Exists!")}var a=new AnimatedRectangle(e,t,n,r,i,s,o,u);this.Nodes[e]=a};this.setNodePosition=function(e,t,n){if(this.Nodes[e]==null||this.Nodes[e]==undefined){return}this.Nodes[e].x=t;this.Nodes[e].y=n}}